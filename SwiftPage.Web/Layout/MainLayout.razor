@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime
@using SwiftPage.Web.Layout

<MudLayout>
    <AppBar OnToggleDrawer="@ToggleDrawer" OnToggleDarkMode="@ToggleDarkMode" ShowHeaderMenu="true" />
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <MudStack Spacing="0">
            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="pa-2">
                <MudText Typo="Typo.h6" Class="ml-2">메뉴</MudText>
                <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" Size="Size.Small"
                    OnClick="@ToggleDrawer" />
            </MudStack>
            <MudDivider />
        </MudStack>
        @* 모바일에서 접근을 위한 간단한 메뉴 (데스크톱에서는 헤더 메뉴 사용) *@
        <MudNavMenu>
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
                홈
            </MudNavLink>
            <MudNavLink Href="/docs" Icon="@Icons.Material.Filled.MenuBook">
                문서
            </MudNavLink>
            <MudNavLink Href="/team" Icon="@Icons.Material.Filled.People">
                팀 소개
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4 mb-8">
            @Body
        </MudContainer>
        <Footer />
    </MudMainContent>
</MudLayout>

@code {
    [CascadingParameter(Name = "App")]
    public App? App { get; set; }

    private bool _drawerOpen = true;

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private async Task ToggleDarkMode()
    {
        if (App != null)
        {
            App.ToggleDarkMode();
            // localStorage에 저장하여 다음 방문 시에도 유지
            try
            {
                await JSRuntime.InvokeVoidAsync("localStorage.setItem", "darkMode", App.IsDarkMode.ToString().ToLower());
            }
            catch { }
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && App != null)
        {
            // localStorage에서 다크모드 설정 불러오기
            try
            {
                var savedDarkMode = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "darkMode");
                if (bool.TryParse(savedDarkMode, out var isDarkMode) && isDarkMode != App.IsDarkMode)
                {
                    App.SetDarkMode(isDarkMode);
                    StateHasChanged();
                }
            }
            catch { }
        }
    }
}
